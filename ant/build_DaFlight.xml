<?xml version="1.0" encoding="UTF-8" ?>
<project name="daflight" basedir="." default="main">
	<property name="version"        value="3.0r1" />
	<property name="mcversion"      value="1.8.8" />
	<property name="author"         value="dags" />
	<property name="project"        value="DaFlight" />
    <property name="package"        value="me"/>
	<property name="mcp.dir"        location="../../.." />
	<property name="eclipse.dir"    location="${mcp.dir}/eclipse" />
	<property name="temp.dir"       location="${mcp.dir}/temp" />
	<property name="build.dir"      location="${mcp.dir}/build" />
	<property name="target.dir"     location="${build.dir}/src" />
	<property name="dist.dir"       location="${build.dir}/dist" />
	<property name="stage.dir"      location="${build.dir}/stage/${ant.project.name}/${version}" />
	<property name="file.type"      value="jar" />

	<property name="python"         location="${mcp.dir}/runtime/bin/python/python_mcp.exe" />

	<target name="main" description="Perform all tasks for a build">
        <antcall target="clean" />
        <antcall target="copysources"/>
        <antcall target="recompile"/>
        <antcall target="reobfuscate"/>
        <antcall target="stage" />
        <antcall target="buildjar" />
	</target>

    <target name="clean">
        <delete dir="${mcp.dir}/bin"/>
        <delete dir="${mcp.dir}/reobf"/>
        <delete dir="${target.dir}"/>

        <mkdir dir="${target.dir}"/>
        <mkdir dir="${mcp.dir}/reobf"/>
        <mkdir dir="${mcp.dir}/bin"/>
    </target>

    <target name="copysources">
        <copy todir="${target.dir}" verbose="false" overwrite="true" failonerror="false">
            <fileset dir="${mcp.dir}/src/minecraft" />
        </copy>
        <copy todir="${target.dir}/${project}" verbose="false" overwrite="true" failonerror="false">
            <fileset dir="${eclipse.dir}/${project}/java" />
        </copy>
    </target>

	<target name="recompile" description="MCP recompile">
		<echo level="info" message="Compiling projects" />
		<echo append="false" file="${temp.dir}/build.cfg" message="[OUTPUT]&#x0A;SrcClient = build/src" />
		<exec executable="${python}" dir="${mcp.dir}">
			<arg value="runtime/recompile.py" />
			<arg value="--client" />
			<arg value="--config" />
			<arg value="${temp.dir}/build.cfg" />
			<arg value="%*" />
		</exec>
	</target>

	<target name="reobfuscate" description="MCP reobfuscate">
		<echo level="info" message="Obfuscating classes" />
		<exec executable="${python}" dir="${mcp.dir}">
			<arg value="runtime/reobfuscate.py" />
			<arg value="--client" />
			<arg value="%*" />
		</exec>
	</target>

    <target name="stage">
        <delete dir="${stage.dir}"/>
        <mkdir dir="${stage.dir}"/>
        <copy todir="${stage.dir}/${package}" verbose="false" overwrite="true" failonerror="false">
            <fileset dir="${mcp.dir}/reobf/minecraft/${package}" />
        </copy>
    </target>

    <target name="buildjar" description="Build the jar file">
        <echo level="info" message="Building final output" />
        <mkdir dir="${dist.dir}" />
        <jar destfile="${dist.dir}/${ant.project.name}-${mcversion}-${version}.${file.type}" duplicate="preserve" index="true" manifestencoding="UTF-8">
            <manifest>
                <attribute name="Built-By" value="MCP (http://mcp.ocean-labs.de)" />
                <attribute name="Implementation-Vendor" value="${author}" />
                <attribute name="Implementation-Title" value="${ant.project.name}" />
                <attribute name="Implementation-Version" value="${version}" />
                <attribute name="TweakClass" value="me.dags.daflight.launch.DaFlightLoaderTweaker" />
                <attribute name="TweakName" value="${project}" />
                <attribute name="TweakVersion" value="${version}" />
                <attribute name="TweakAuthor" value="${author}" />
            </manifest>
            <fileset dir="${stage.dir}"/>
        </jar>
    </target>
</project>